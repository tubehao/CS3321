{% extends "layouts/base.html" %}
{% block title %}Chat Interface{% endblock %}

{% block stylesheets %}
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            font-size: 16px;
            color: #333;
            background-color: #f8f9fa;
        }
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 80vh;
            max-height: 80vh;
            overflow: hidden;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .chat-input {
            border-top: 1px solid #ddd;
            padding: 10px;
            /* display: flex;
            justify-content: center; */
        }
        .message {
            margin-bottom: 15px;
            width: 70%;
            display: flex;
            padding: 10px;
            border-radius: 10px;
        }
        .message.user {
            justify-content: flex-end;
        }
        .message.user .message-content {
            background-color: white;
            display: inline-block;
            padding: 10px;
            border-radius: 10px;
        }
        .message.bot {
            justify-content: flex-start;
            background-color: white;
        }
        .message.bot .message-content {
            display: flex;
            justify-content: space-between;
            width: 100%;
            padding: 10px;
            border-radius: 10px;
        }
        .message.bot .column {
            width: 48%;
        }
        .message.bot .column h2 {
            text-align: center;
        }
        .graph-container {
            width: 100%;
            height: 300px; /* Adjust the height as needed */
        }
        .database-select-container {
            margin-bottom: 10px;
            width: 10%;
        }
        .database-select {
            width: 100%;
            padding: 5px;
            font-size: 16px;
            border: 2px solid #007bff;
            border-radius: 5px;
            background-color: #e7f3ff;
            color: #007bff;
        }
    </style>
{% endblock stylesheets %}

{% block content %}
    <div class="container-fluid chat-container">
        <div class="chat-messages" id="chat-messages">
            <!-- Messages will be dynamically inserted here -->
        </div>
        <div class="chat-input">
            <div class="database-select-container">
                <select class="database-select" id="database-select">
                    {% for db in databases %}
                    <option value="{{ db }}">{{ db }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="input-group">
                <input type="text" class="form-control" placeholder="Type a message" id="message-input">
                <div class="input-group-append">
                    <button class="btn btn-primary" type="button" id="send-button">Send</button>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}

{% block javascripts %}
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://unpkg.com/@antv/g6@5/dist/g6.min.js"></script>
<script>
    $(document).ready(function () {
        // 在页面加载完成后立即显示欢迎信息
        var welcomeMessage = 'Hello, how can I help you?';
        var welcomeMessageHtml = '<div class="message bot"><div class="message-content">' + marked.parse(welcomeMessage) + '</div></div>';
        $('#chat-messages').append(welcomeMessageHtml);

        $('#send-button').on('click', function () {
            sendMessage();
        });

        $('#message-input').on('keypress', function (e) {
            if (e.which == 13) {
                sendMessage();
            }
        });

        $('#database-select').on('change', function () {
            var selectedDatabase = $(this).val();
            $.ajax({
                url: '{{ url_for("chat.set_database") }}',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({database: selectedDatabase}),
                success: function (response) {
                    console.log('Database selection saved:', response);
                }
            });
        });

        function sendMessage() {
            var message = $('#message-input').val();
            if (message.trim() !== '') {
                var userMessageHtml = '<div class="message user"><div class="message-content">' + marked.parse(message) + '</div></div>';
                $('#chat-messages').append(userMessageHtml);
                $('#message-input').val('');
                // 发送用户消息到后端
                $.ajax({
                    url: '{{ url_for("chat.get_response") }}',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({message: message}),
                    success: function(response) {
                        var botMessageHtml = '<div class="message bot"><div class="message-content">';
                        
                            botMessageHtml += '<div class="column text-column"> <h2> Graph Talker </h2>';
                            if (response.graph_data.nodes.length > 0) {
                                var graphId = "graph-" + Date.now(); // 生成一个时间戳ID
                                query = "```"+response.query+"```";
                                botMessageHtml += 'To get knowledge, we can use the following query in database <br> '+marked.parse(query)+'<h3> Query Result</h3><div class="graph-container" id="' + graphId + '"></div>';
                            }
                            botMessageHtml += '<h3> Solution</h3>';
                            botMessageHtml += marked.parse(response.solution_part1);
                            if (response.visualize_data.nodes.length > 0) {
                                var visualID = "graph-" + Date.now()+1; // 生成一个时间戳ID
                                botMessageHtml += '<div class="graph-container" id="' + visualID + '"></div>';
                            }
                            botMessageHtml += '</div><div class="column text-column"> <h2> GPT4 </h2>' + marked.parse(response.solution_part2) + '</div></div></div>';

                            $('#chat-messages').append(botMessageHtml);

                            // 确保元素已被添加到 DOM 中后再执行 visualizeGraph
                            if (response.graph_data.nodes.length > 0) {
                                setTimeout(function() {
                                    var container = document.getElementById(graphId);
                                    visualizeGraph(response.graph_data, container);
                                }, 0);
                            }

                            if (response.visualize_data.nodes.length > 0) {
                                setTimeout(function() {
                                    var container = document.getElementById(visualID);
                                    visualizeGraph(response.visualize_data, container);
                                }, 0);
                            }

                            // if (response.graph_data.nodes.length > 0) {
                                
                            // }
                    }
                });
            }
        }

        function visualizeGraph(graphData, container) {
            const graph = new G6.Graph({
                container: container,
                width: container.offsetWidth,
                
                height: container.offsetHeight,
                layout: {
                    type: 'force',
                    // preventOverlap: true,
                },

                behaviors: ['drag-node', 'zoom-canvas', 'drag-canvas'],

                node: {
                    size: 20,
                    color: '#5B8FF9',
                    
                    // labelCfg: {
                    //     style: {
                    //         fill: '#000', // 标签字体颜色
                    //         fontSize: 12, // 标签字体大小
                    //     },
                    //     position: 'bottom', // 标签位置，可选值有 'top', 'bottom', 'left', 'right' 等
                    // },
                    style: {
                        // iconText: (d) => d.data,
                        labelText: (d) => d.id,
                    }
                    
                },
                edge: {
                    type:'line',
                    style: {
                        stroke: '#000000',
                    },
                },
                // nodeStateStyles: {
                //     hover: {
                //         fill: 'lightsteelblue'
                //     }
                // }
            });

            // graph.on('node:mouseenter', (e) => {
            //     graph.setItemState(e.item, 'hover', true);
            // });

            // graph.on('node:mouseleave', (e) => {
            //     graph.setItemState(e.item, 'hover', false);
            // });

            graph.setData(graphData);
            graph.render();
            // window.onresize = () => {
            //     if (!graph || graph.get('destroyed')) return;
            //     if (!container || !container.scrollWidth || !container.scrollHeight) return;
            //     graph.changeSize(container.scrollWidth, container.scrollHeight);
            // };
        }
    });
</script>
{% endblock javascripts %}